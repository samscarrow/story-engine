# Oracle Database Connection and Schema Analysis

## Connection Test Results

### Status: ⚠️ Database Connection Configured but Instance Paused

The Oracle connection setup is correctly configured with:
- ✅ Oracle wallet files present and valid
- ✅ TNS configuration properly set up for MAINBASE
- ✅ Environment variables configured (.env.oracle)
- ✅ oracledb Python library installed
- ✅ Connection code properly implemented

**Issue**: Database returns ORA-12506 (Listener refused connection), indicating the Autonomous Database instance is likely **paused** to save costs.

**Solution**: Resume the MAINBASE database instance in Oracle Cloud Console before testing.

## Schema Management in Oracle Autonomous Database

### Current Setup
- **User**: ADMIN (database administrator)
- **Schema**: ADMIN (default schema for ADMIN user)
- **Connection**: mainbase_high (high performance service)

### Schema Options Analysis

#### Option 1: Use ADMIN Schema (Current)
**Pros:**
- ✅ No additional setup required
- ✅ Full administrative privileges
- ✅ Can create/manage tables freely
- ✅ Simple configuration

**Cons:**
- ⚠️ Tables mixed with system admin objects
- ⚠️ Less organized for production use
- ⚠️ Harder to manage permissions later

#### Option 2: Create Dedicated STORY_DB User/Schema
**Pros:**
- ✅ Clean separation of story engine data
- ✅ Better security isolation
- ✅ Easier to manage permissions
- ✅ Professional database design

**Cons:**
- ⚠️ Requires additional user creation
- ⚠️ More complex permission management
- ⚠️ Additional connection configuration needed

### Recommended Approach: Dedicated Schema

For a production-ready setup, we should create a dedicated `STORY_DB` schema:

```sql
-- Create dedicated user for story engine
CREATE USER story_db IDENTIFIED BY "SecurePassword123!";

-- Grant necessary privileges
GRANT CONNECT, RESOURCE TO story_db;
GRANT UNLIMITED TABLESPACE TO story_db;

-- Grant specific privileges for story engine operations
GRANT CREATE TABLE TO story_db;
GRANT CREATE SEQUENCE TO story_db;
GRANT CREATE VIEW TO story_db;
```

## Tables and Schema Design

### Core Tables Needed

1. **workflow_outputs** (Already implemented)
   ```sql
   CREATE TABLE workflow_outputs (
       id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       workflow_name VARCHAR2(255) NOT NULL,
       output_data CLOB NOT NULL,
       timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

2. **Additional Story Engine Tables** (Future)
   - `characters` - Character definitions and personas
   - `world_states` - World state snapshots
   - `scenes` - Generated scenes and contexts
   - `narratives` - Complete story outputs
   - `simulation_runs` - Simulation execution metadata

### Performance Considerations

- Use CLOB for large text data (story content, world states)
- Index frequently queried columns (workflow_name, timestamp)
- Consider partitioning for large datasets
- Use Oracle's JSON datatype for structured metadata

## Implementation Steps

### Immediate (When Database is Resumed)
1. Test connection with existing ADMIN schema
2. Verify workflow_outputs table creation
3. Test basic CRUD operations
4. Validate CLOB handling for large content

### Next Steps (Production Readiness)
1. Create dedicated STORY_DB user/schema
2. Migrate tables to new schema
3. Update connection configuration
4. Implement proper error handling and connection pooling
5. Add monitoring and logging

## Configuration Files Update Needed

### .env.oracle (for dedicated schema)
```env
DB_TYPE=oracle
DB_USER=STORY_DB
DB_PASSWORD=SecurePassword123!
DB_DSN=mainbase_high
DB_WALLET_LOCATION=./oracle_wallet
DB_WALLET_PASSWORD=kxg-wak-ZAV-hct7txu
TNS_ADMIN=./oracle_wallet
```

### Connection Pool Configuration
```python
# For production, consider connection pooling
pool = oracledb.create_pool(
    user="story_db",
    password="SecurePassword123!",
    dsn="mainbase_high",
    config_dir="./oracle_wallet",
    min=2,
    max=10,
    increment=1
)
```

## Next Actions Required

1. **IMMEDIATE**: Resume MAINBASE database in Oracle Cloud Console
2. **TEST**: Run connection test once database is active
3. **DECIDE**: Choose between ADMIN schema (quick) or dedicated schema (proper)
4. **IMPLEMENT**: Set up chosen schema approach
5. **VALIDATE**: Test all story engine database operations

## Error Handling Recommendations

```python
# Implement proper retry logic for connection issues
def connect_with_retry(max_retries=3, delay=5):
    for attempt in range(max_retries):
        try:
            conn = oracledb.connect(...)
            return conn
        except oracledb.DatabaseError as e:
            if "12506" in str(e) and attempt < max_retries - 1:
                print(f"Database appears paused, waiting {delay}s...")
                time.sleep(delay)
                continue
            raise
```